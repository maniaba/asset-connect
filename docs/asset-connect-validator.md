# AssetConnectValidator

The `AssetConnectValidator` class is a powerful tool for validating file uploads in your application. It works together with the `ValidationRuleCollector` to generate validation rules based on asset collection definitions and validate data against these rules.

## Overview

The `AssetConnectValidator` class provides a flexible way to validate file uploads by:

1. Generating validation rules from asset collection definitions
2. Supporting validation of multiple fields with different collection definitions
3. Providing methods to validate data against these rules
4. Supporting validation directly from HTTP requests

## Basic Usage

```php
// Create a validator
$validator = new \Maniaba\FileConnect\Validation\AssetConnectValidator();

// Set a field collection definition
$validator->setFieldCollectionDefinition('file', new YourCollectionDefinition());

// Validate data
$data = [
    'file' => $this->request->getFile('upload')
];

if ($validator->validate($data)) {
    // Validation passed
    // Process the file
} else {
    // Validation failed
    $errors = $validator->getErrors();
    // Handle errors
}
```

## Key Methods

### Setting Field Collection Definitions

```php
$validator->setFieldCollectionDefinition('fieldName', $collectionDefinition);
```

This method associates a field name with a specific collection definition. The collection definition determines what validation rules will be applied to the field.

### Validating Data

```php
// Validate all fields
$validator->validate($data);

// Validate specific fields
$validator->validateFields($data, 'field1', 'field2');

// Validate all defined fields
$validator->validateDefinedFields($data);
// Note: "DefinedFields" refers to fields that were added via the setFieldCollectionDefinition method
```

### Validating from Request

```php
// Validate specific fields from request
$validator->validateFieldsFromRequest('field1', 'field2');

// Validate all defined fields from request
$validator->validateRequest();
// Note: "DefinedFields" refers to fields that were added via the setFieldCollectionDefinition method
```

### Getting Rules and Errors

```php
// Get all rules
$allRules = $validator->getRules();

// Get rules for specific fields
$fieldRules = $validator->getRulesForFields('field1', 'field2');

// Get rules for all defined fields
$definedFieldRules = $validator->getRulesForDefinedFields();

// Get validation errors
$errors = $validator->getErrors();
```

The `getRules()` method returns CodeIgniter 4 compatible validation rules for the current validator instance. This is particularly useful when you want to combine AssetConnectValidator rules with additional validation rules for other fields in your form and continue validation using CodeIgniter 4's validator.

#### Example: Combining with CodeIgniter 4 Validator

```php
// Create AssetConnectValidator and set up rules for file uploads
$fileValidator = new \Maniaba\FileConnect\Validation\AssetConnectValidator();
$fileValidator->setFieldCollectionDefinition('profile_image', new ProfileImageCollection());

// Get the rules generated by AssetConnectValidator
$fileRules = $fileValidator->getRules();

// Create a standard CodeIgniter validator with additional rules
$validation = \Config\Services::validation();
$validation->setRules([
    // Add file upload rules from AssetConnectValidator
    ...$fileRules,

    // Add additional rules for other form fields
    'username' => 'required|min_length[5]|max_length[50]',
    'email' => 'required|valid_email',
    'age' => 'required|integer|greater_than[17]'
]);

// Run validation on all fields together
if ($validation->withRequest($this->request)->run()) {
    // All validation passed (both files and other fields)
    // Process the form data
} else {
    // Validation failed
    $errors = $validation->getErrors();
    // Handle errors
}
```

This approach allows you to seamlessly integrate file validation with other form field validations in your application.

## Working with ValidationRuleCollector

The `ValidationRuleCollector` class is used internally by `AssetConnectValidator` to collect validation rules from asset collection definitions. It implements the `AssetCollectionSetterInterface` and provides methods to set various validation constraints.

### How They Work Together

1. `AssetConnectValidator` creates a `ValidationRuleCollector` for each field
2. The collection definition's `definition()` method is called with the rule collector
3. The rule collector collects validation rules based on the methods called on it
4. `AssetConnectValidator` retrieves the collected rules and uses them for validation

### Example Collection Definition

```php
class ImagesCollection implements AssetCollectionDefinitionInterface
{
    public function definition(AssetCollectionSetterInterface $definition): void
    {
        $definition
            ->allowedExtensions(AssetExtension::JPG, AssetExtension::PNG)
            ->allowedMimeTypes(AssetMimeType::IMAGE_JPEG, AssetMimeType::IMAGE_PNG)
            ->setMaxFileSize(2 * 1024 * 1024) // 2MB
            ->setMaxImageDimensions(1920, 1080)
            ->requireImage()
            ->singleFileCollection();
    }
}
```

## ValidationRuleCollector Methods

The `ValidationRuleCollector` provides the following methods for setting validation constraints:

### File Validation

- `allowedExtensions(AssetExtension|string ...$extensions)`: Validates file extensions
- `allowedMimeTypes(AssetMimeType|string ...$mimeTypes)`: Validates MIME types
- `setMaxFileSize(float|int $maxFileSize)`: Validates maximum file size
- `singleFileCollection()`: Ensures only a single file is uploaded
- `onlyKeepLatest(int $maximumNumberOfItemsInCollection)`: Limits the number of files

### Image Validation

- `setMaxImageDimensions(int $width, int $height)`: Validates maximum image dimensions
- `setMinImageDimensions(int $width, int $height)`: Validates minimum image dimensions
- `requireImage()`: Ensures the file is an image

## Complete Example

Here's a complete example showing how to use `AssetConnectValidator` with multiple fields and different collection definitions:

```php
// Define collection definitions
class ProfileImageCollection implements AssetCollectionDefinitionInterface
{
    public function definition(AssetCollectionSetterInterface $definition): void
    {
        $definition
            ->allowedExtensions(AssetExtension::JPG, AssetExtension::PNG)
            ->allowedMimeTypes(AssetMimeType::IMAGE_JPEG, AssetMimeType::IMAGE_PNG)
            ->setMaxFileSize(1 * 1024 * 1024) // 1MB
            ->setMaxImageDimensions(500, 500)
            ->requireImage()
            ->singleFileCollection();
    }
}

class DocumentsCollection implements AssetCollectionDefinitionInterface
{
    public function definition(AssetCollectionSetterInterface $definition): void
    {
        $definition
            ->allowedExtensions(AssetExtension::PDF, AssetExtension::DOC, AssetExtension::DOCX)
            ->allowedMimeTypes(
                AssetMimeType::APPLICATION_PDF,
                AssetMimeType::APPLICATION_MSWORD,
                AssetMimeType::APPLICATION_DOCX
            )
            ->setMaxFileSize(5 * 1024 * 1024) // 5MB
            ->onlyKeepLatest(3); // Allow up to 3 documents
    }
}

// In your controller
public function upload()
{
    // Create a validator
    $validator = new \Maniaba\FileConnect\Validation\AssetConnectValidator();

    // Set field collection definitions
    $validator->setFieldCollectionDefinition('profile_image', new ProfileImageCollection());
    $validator->setFieldCollectionDefinition('documents', new DocumentsCollection());

    // Validate from request
    if ($validator->validateRequest()) {
        // Validation passed

        // Get the files
        $profileImage = $this->request->getFile('profile_image');
        $documents = $this->request->getFileMultiple('documents');

        // Process the files
        // ...

        return redirect()->to('/success')->with('message', 'Files uploaded successfully');
    } else {
        // Validation failed
        $errors = $validator->getErrors();

        return redirect()->back()->withInput()->with('errors', $errors);
    }
}
```

## Advanced Usage

### Validating Multiple File Uploads

For multiple file uploads, you can use the `onlyKeepLatest` method to limit the number of files:

```php
class MultipleImagesCollection implements AssetCollectionDefinitionInterface
{
    public function definition(AssetCollectionSetterInterface $definition): void
    {
        $definition
            ->allowedExtensions(AssetExtension::JPG, AssetExtension::PNG)
            ->allowedMimeTypes(AssetMimeType::IMAGE_JPEG, AssetMimeType::IMAGE_PNG)
            ->setMaxFileSize(2 * 1024 * 1024) // 2MB
            ->requireImage()
            ->onlyKeepLatest(5); // Allow up to 5 images
    }
}
```

Then validate as usual:

```php
$validator->setFieldCollectionDefinition('gallery_images', new MultipleImagesCollection());

if ($validator->validateFieldsFromRequest('gallery_images')) {
    $images = $this->request->getFileMultiple('gallery_images');
    // Process the images
}
```

## Conclusion

The `AssetConnectValidator` and `ValidationRuleCollector` classes provide a powerful and flexible way to validate file uploads in your application. By defining collection definitions with specific validation rules, you can ensure that uploaded files meet your requirements before processing them.
